<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="When you watch carefully outside from the front-end world, and you don’t want to be deceived by this “monotonous” code world, but also you’re afraid of seeing it wrong or missing any beauty of it.Lets">
<meta property="og:type" content="article">
<meta property="og:title" content="Min heap in React">
<meta property="og:url" content="https://ankiyang.github.io/2020/01/22/Min-heap-in-React/index.html">
<meta property="og:site_name" content="ANK">
<meta property="og:description" content="When you watch carefully outside from the front-end world, and you don’t want to be deceived by this “monotonous” code world, but also you’re afraid of seeing it wrong or missing any beauty of it.Lets">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2020-01-22T07:45:35.000Z">
<meta property="article:modified_time" content="2020-11-24T07:46:58.539Z">
<meta property="article:author" content="Anki Yang">
<meta property="article:tag" content="Javascript">
<meta property="article:tag" content="React">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Min heap in React</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 5.2.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">My Writing</a></li>
         
          <li><a href="/articles/">Articles</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2020/10/26/Can-a-container-exist-separated-from-a-process/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2019/01/10/Array-In-Javascript/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://ankiyang.github.io/2020/01/22/Min-heap-in-React/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://ankiyang.github.io/2020/01/22/Min-heap-in-React/&text=Min heap in React"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://ankiyang.github.io/2020/01/22/Min-heap-in-React/&title=Min heap in React"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://ankiyang.github.io/2020/01/22/Min-heap-in-React/&is_video=false&description=Min heap in React"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Min heap in React&body=Check out this article: https://ankiyang.github.io/2020/01/22/Min-heap-in-React/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://ankiyang.github.io/2020/01/22/Min-heap-in-React/&title=Min heap in React"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://ankiyang.github.io/2020/01/22/Min-heap-in-React/&title=Min heap in React"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://ankiyang.github.io/2020/01/22/Min-heap-in-React/&title=Min heap in React"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://ankiyang.github.io/2020/01/22/Min-heap-in-React/&title=Min heap in React"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://ankiyang.github.io/2020/01/22/Min-heap-in-React/&name=Min heap in React&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://ankiyang.github.io/2020/01/22/Min-heap-in-React/&t=Min heap in React"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Min heap in React
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Anki Yang</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2020-01-22T07:45:35.000Z" itemprop="datePublished">2020-01-22</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/Frontend/">Frontend</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/Javascript/" rel="tag">Javascript</a>, <a class="tag-link-link" href="/tags/React/" rel="tag">React</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>When you watch carefully outside from the front-end world, and you don’t want to be deceived by this “monotonous” code world, but also you’re afraid of seeing it wrong or missing any beauty of it.<br>Lets start with a PR of React from version 16.10.0.</p>
<blockquote>
<p>Improve queue performance by switching its internal data structure to a min binary heap. ( <a target="_blank" rel="noopener" href="https://github.com/acdlite">@acdlite</a> in <a target="_blank" rel="noopener" href="https://github.com/facebook/react/pull/16245">#16245</a> )  </p>
</blockquote>
<p>So in order to understand what this PR had optimised.  Lets review some knowledge.</p>
<ol>
<li>One of the hard problem of front-end optimisation is solving browser freezing(浏览器卡顿). Basically because Javascript is single-threaded in our browser  and Js thread could modify DOM and then make pages change. But  in order to ensure our page would display safely, when Js is modifying DOM, our browser will let Js thread and UI rendering thread <strong>mutex</strong>(互斥). In other words, every time we run our JS code, UI rendering thread would suspend and all UI update would be saved in queue until Js thread is idle and then to render pages.</li>
</ol>
<p>But this design has posed an inevitable problem: long-time JS execution would cause UI threads in browser suspending for a long time and it couldn’t render any more and response to users’ events. In result, we feel the stuck.</p>
<ol start="2">
<li>Before version 16.0+ of React, there was a <strong>Stack Reconciler</strong> scheduling algorithm which simply is to do <a target="_blank" rel="noopener" href="https://programmingwithmosh.com/react/react-virtual-dom-explained/">virtual DOM(VDOM)</a> diff and calculate the real DOM need to be updated and then call native APIs to manipulate DOM. Obviously, it would cause “long-time Javascript execution”.<br>To address this problem, React v16 used new <em><a target="_blank" rel="noopener" href="https://github.com/acdlite/react-fiber-architecture">Fiber</a></em> scheduling algorithm  through <strong>Concurrent</strong>(竞争渲染) and <strong>Schedular</strong>(任务调度) collaboratively.</li>
</ol>
<ul>
<li>“Concurrent” would split synchronous rendering DOM process to asynchronous rendering step by step. Thus,  by executing long rendering tasks in batches, browsers could get a break and to support UI rendering and to respond user events.</li>
<li>“Schedular” support  multi-priority rendering at React framework level. It schedule the “concurrent” system ensuring different missions in slice (分片)execute according to different priorities.</li>
</ul>
<p>Lets back to this PR😂.  To avoid long-time Javascript sequential execution, the new scheduling algorithm of React hold a Js execution queue.Every Js mission in the queue has different priority.It would be executed as much as possible as  different priorities during every browser rendering.In a limited execution time，not completed missions would be left to the next rendering interval, those already completed missions dequeue. In this way, those Js tasks that need to be performed for a long time are split into slicing tasks with different priorities, preventing the browser to let UI thread from being suspended and causing stuck. Those split tasks with different priorities would be executed “as the case may be “ at each rendering interval.</p>
<p>So how to maintain and proceed this queue with priorities.<br>Earlier, React 16 utilised linked list to record data, specifically a <a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/doubly-circular-linked-list-set-1-introduction-and-insertion/">double circular linked list structure (双向循环链表结构)</a> to operate tasks in the <strong>Scheduler</strong>.<br>Each task match 5 different priorities.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">const ImmediatePriority &#x3D; 1 </span><br><span class="line">const UserBlockingPriority &#x3D; 2 </span><br><span class="line">const NormalPriority &#x3D; 3 </span><br><span class="line">const LowPriority &#x3D; 4 </span><br><span class="line">const IdlePriority &#x3D; 5</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>To prevent <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Starvation_(computer_science">Starvation problem</a>, there are five expiration times for each task.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Times out immediately </span><br><span class="line">const IMMEDIATE_PRIORITY_TIMEOUT &#x3D; -1; </span><br><span class="line">&#x2F;&#x2F; Eventually times out </span><br><span class="line">const USER_BLOCKING_PRIORITY &#x3D; 250; </span><br><span class="line">const NORMAL_PRIORITY_TIMEOUT &#x3D; 5000; </span><br><span class="line">const LOW_PRIORITY_TIMEOUT &#x3D; 10000; </span><br><span class="line">&#x2F;&#x2F; Never times out </span><br><span class="line">const IDLE_PRIORITY &#x3D; maxSigned31BitInt;</span><br></pre></td></tr></table></figure>


<p><strong>Using linked list to maintain our priority queue</strong>: we add every task to the list, and use <code>performance.now() + timeout</code>  to record the expiration time of this task at the same time. <strong>timeout</strong> is related to the above 5 priorities. Of course, the higher priority, expiration time for timeout would be more short. Because, if it is expired, it need to be performed immediately. Thus, the higher priority for task, the easier for this task will be expired.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/facebook/react/blob/901139c2910d0dc33f07f85c748c64371f8664f4/packages/scheduler/src/Scheduler.js#L279">Relevant React source code</a>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">function timeoutForPriorityLevel(priorityLevel) &#123;</span><br><span class="line">  switch (priorityLevel) &#123;</span><br><span class="line">    case ImmediatePriority:</span><br><span class="line">      return IMMEDIATE_PRIORITY_TIMEOUT;</span><br><span class="line">    case UserBlockingPriority:</span><br><span class="line">      return USER_BLOCKING_PRIORITY;</span><br><span class="line">    case IdlePriority:</span><br><span class="line">      return IDLE_PRIORITY;</span><br><span class="line">    case LowPriority:</span><br><span class="line">      return LOW_PRIORITY_TIMEOUT;</span><br><span class="line">    case NormalPriority:</span><br><span class="line">    default:</span><br><span class="line">      return NORMAL_PRIORITY_TIMEOUT;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">function unstable_scheduleCallback(priorityLevel, callback, options) &#123;</span><br><span class="line"></span><br><span class="line">  var currentTime &#x3D; getCurrentTime();</span><br><span class="line"></span><br><span class="line">  var startTime;</span><br><span class="line">  var timeout;</span><br><span class="line">  if (typeof options &#x3D;&#x3D;&#x3D; ‘object’ &amp;&amp; options !&#x3D;&#x3D; null) &#123;</span><br><span class="line">    var delay &#x3D; options.delay;</span><br><span class="line">    if (typeof delay &#x3D;&#x3D;&#x3D; ‘number’ &amp;&amp; delay &gt; 0) &#123;</span><br><span class="line">      startTime &#x3D; currentTime + delay;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      startTime &#x3D; currentTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    timeout &#x3D;</span><br><span class="line">      typeof options.timeout &#x3D;&#x3D;&#x3D; ‘number’</span><br><span class="line">        ? options.timeout</span><br><span class="line">        : timeoutForPriorityLevel(priorityLevel);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    timeout &#x3D; timeoutForPriorityLevel(priorityLevel);</span><br><span class="line">    startTime &#x3D; currentTime;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  var expirationTime &#x3D; startTime + timeout;</span><br><span class="line"></span><br><span class="line">  var newTask &#x3D; &#123;</span><br><span class="line">    id: taskIdCounter++,</span><br><span class="line">    callback,</span><br><span class="line">    priorityLevel,</span><br><span class="line">    startTime,</span><br><span class="line">    expirationTime,</span><br><span class="line">    sortIndex: -1,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  if (enableProfiling) &#123;</span><br><span class="line">    newTask.isQueued &#x3D; false;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  if (startTime &gt; currentTime) &#123;</span><br><span class="line">    &#x2F;&#x2F; This is a delayed task.</span><br><span class="line">    newTask.sortIndex &#x3D; startTime;</span><br><span class="line">    push(timerQueue, newTask);</span><br><span class="line">    if (peek(taskQueue) &#x3D;&#x3D;&#x3D; null &amp;&amp; newTask &#x3D;&#x3D;&#x3D; peek(timerQueue)) &#123;</span><br><span class="line">      &#x2F;&#x2F; All tasks are delayed, and this is the task with the earliest delay.</span><br><span class="line">      if (isHostTimeoutScheduled) &#123;</span><br><span class="line">        &#x2F;&#x2F; Cancel an existing timeout.</span><br><span class="line">        cancelHostTimeout();</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        isHostTimeoutScheduled &#x3D; true;</span><br><span class="line">      &#125;</span><br><span class="line">      &#x2F;&#x2F; Schedule a timeout.</span><br><span class="line">      requestHostTimeout(handleTimeout, startTime - currentTime);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    newTask.sortIndex &#x3D; expirationTime;</span><br><span class="line">    push(taskQueue, newTask);</span><br><span class="line">    if (enableProfiling) &#123;</span><br><span class="line">      markTaskStart(newTask, currentTime);</span><br><span class="line">      newTask.isQueued &#x3D; true;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; Schedule a host callback, if needed. If we’re already performing work,</span><br><span class="line">    &#x2F;&#x2F; wait until the next time we yield.</span><br><span class="line">    if (!isHostCallbackScheduled &amp;&amp; !isPerformingWork) &#123;</span><br><span class="line">      isHostCallbackScheduled &#x3D; true;</span><br><span class="line">      requestHostCallback(flushWork);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  return newTask;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>At each rendering time slice interval, we all execute the tasks in the priority queue:  at that time, the task at the head to the queue would be selected for execution, that is, the item in the queue with the highest priority will be scheduled for execution first. We wanna use a double circular linked list to achieve priority queue.It is easy to determine the head and tail of this list, but, if we wanna insert a new task sequentially, then we have to traverse the entire queue and the time complexity would be relatively high.</p>
<p>OK🤣🤣 We transfer to another data structure.<br><a target="_blank" rel="noopener" href="https://www.cs.cmu.edu/~tcortina/15-121sp10/Unit06B.pdf"><em>Min heap</em></a><br>  min-heap is a sorted complete binary tree data structure. It is also a very common data structure for implementing priority queue, for example, <a target="_blank" rel="noopener" href="https://github.com/beanstalkd/beanstalkd">Beanstalked</a> uses a min-heap to achieve priority queues.  The time complexity of manipulations are :</p>
<ul>
<li>insert a task: O(log N)</li>
<li>delete a task: O(log N)</li>
<li>find minimum value: O(1)</li>
<li>delete minimum value: O(log N)</li>
<li>combine: O(N)</li>
</ul>
<p>This is the official description from React😂:</p>
<blockquote>
<p>Heaps are the standard way to implement priority queues. Insertion is O(1) in the average case (append to the end) and O(log n) in the worst. Deletion is O(log n). Peek is O(1).  </p>
</blockquote>
<p>In conclusion , this PR in React, is exactly to use min-heap in place of double circular linked list to implement a priority queue.</p>
<p>The source code of the min-heap implementation in React, very simple and easy to understand😌:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">type Heap &#x3D; Array&lt;Node&gt;;</span><br><span class="line">type Node &#x3D; &#123;</span><br><span class="line">  id: number,</span><br><span class="line">  sortIndex: number,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">export function push(heap: Heap, node: Node): void &#123;</span><br><span class="line">  const index &#x3D; heap.length;</span><br><span class="line">  heap.push(node);</span><br><span class="line">  siftUp(heap, node, index);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export function peek(heap: Heap): Node | null &#123;</span><br><span class="line">  const first &#x3D; heap[0];</span><br><span class="line">  return first &#x3D;&#x3D;&#x3D; undefined ? null : first;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export function pop(heap: Heap): Node | null &#123;</span><br><span class="line">  const first &#x3D; heap[0];</span><br><span class="line">  if (first !&#x3D;&#x3D; undefined) &#123;</span><br><span class="line">    const last &#x3D; heap.pop();</span><br><span class="line">    if (last !&#x3D;&#x3D; first) &#123;</span><br><span class="line">      heap[0] &#x3D; last;</span><br><span class="line">      siftDown(heap, last, 0);</span><br><span class="line">    &#125;</span><br><span class="line">    return first;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    return null;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function siftUp(heap, node, index) &#123;</span><br><span class="line">  while (true) &#123;</span><br><span class="line">    const parentIndex &#x3D; Math.floor((index - 1) &#x2F; 2);</span><br><span class="line">    const parent &#x3D; heap[parentIndex];</span><br><span class="line">    if (parent !&#x3D;&#x3D; undefined &amp;&amp; compare(parent, node) &gt; 0) &#123;</span><br><span class="line">      &#x2F;&#x2F; The parent is larger. Swap positions.</span><br><span class="line">      heap[parentIndex] &#x3D; node;</span><br><span class="line">      heap[index] &#x3D; parent;</span><br><span class="line">      index &#x3D; parentIndex;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      &#x2F;&#x2F; The parent is smaller. Exit.</span><br><span class="line">      return;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function siftDown(heap, node, index) &#123;</span><br><span class="line">  const length &#x3D; heap.length;</span><br><span class="line">  while (index &lt; length) &#123;</span><br><span class="line">    const leftIndex &#x3D; (index + 1) * 2 - 1;</span><br><span class="line">    const left &#x3D; heap[leftIndex];</span><br><span class="line">    const rightIndex &#x3D; leftIndex + 1;</span><br><span class="line">    const right &#x3D; heap[rightIndex];</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; If the left or right node is smaller, swap with the smaller of those.</span><br><span class="line">    if (left !&#x3D;&#x3D; undefined &amp;&amp; compare(left, node) &lt; 0) &#123;</span><br><span class="line">      if (right !&#x3D;&#x3D; undefined &amp;&amp; compare(right, left) &lt; 0) &#123;</span><br><span class="line">        heap[index] &#x3D; right;</span><br><span class="line">        heap[rightIndex] &#x3D; node;</span><br><span class="line">        index &#x3D; rightIndex;</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        heap[index] &#x3D; left;</span><br><span class="line">        heap[leftIndex] &#x3D; node;</span><br><span class="line">        index &#x3D; leftIndex;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; else if (right !&#x3D;&#x3D; undefined &amp;&amp; compare(right, node) &lt; 0) &#123;</span><br><span class="line">      heap[index] &#x3D; right;</span><br><span class="line">      heap[rightIndex] &#x3D; node;</span><br><span class="line">      index &#x3D; rightIndex;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      &#x2F;&#x2F; Neither child is smaller. Exit.</span><br><span class="line">      return;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function compare(a, b) &#123;</span><br><span class="line">  &#x2F;&#x2F; Compare sort index first, then task id.</span><br><span class="line">  const diff &#x3D; a.sortIndex - b.sortIndex;</span><br><span class="line">  return diff !&#x3D;&#x3D; 0 ? diff : a.id - b.id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>End.</p>
<p><strong>Happy  Happy coding and learning！Everyday!</strong><br>🥳</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">My Writing</a></li>
         
          <li><a href="/articles/">Articles</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://ankiyang.github.io/2020/01/22/Min-heap-in-React/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://ankiyang.github.io/2020/01/22/Min-heap-in-React/&text=Min heap in React"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://ankiyang.github.io/2020/01/22/Min-heap-in-React/&title=Min heap in React"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://ankiyang.github.io/2020/01/22/Min-heap-in-React/&is_video=false&description=Min heap in React"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Min heap in React&body=Check out this article: https://ankiyang.github.io/2020/01/22/Min-heap-in-React/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://ankiyang.github.io/2020/01/22/Min-heap-in-React/&title=Min heap in React"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://ankiyang.github.io/2020/01/22/Min-heap-in-React/&title=Min heap in React"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://ankiyang.github.io/2020/01/22/Min-heap-in-React/&title=Min heap in React"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://ankiyang.github.io/2020/01/22/Min-heap-in-React/&title=Min heap in React"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://ankiyang.github.io/2020/01/22/Min-heap-in-React/&name=Min heap in React&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://ankiyang.github.io/2020/01/22/Min-heap-in-React/&t=Min heap in React"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2021
    Anki Yang
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">My Writing</a></li>
         
          <li><a href="/articles/">Articles</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->


</body>
</html>
